# 可灵 (Kling) 视频生成计费策略文档

## 概述

本文档详细说明 NewAPI 中可灵视频生成服务的计费策略，包括官方价格、计算公式和系统配置方式。

---

## 计费公式

```
最终价格 = ModelPrice × GetPriceScale() × GroupRatio
```

其中：
- **ModelPrice**: 系统设置中配置的模型基础价格（建议设为每秒价格）
- **GetPriceScale()**: 适配器返回的动态倍率 = `duration × unitPriceScale`
- **GroupRatio**: 用户分组倍率

---

## 系统配置

### 推荐的 ModelPrice 配置

在 **系统设置 → 运营设置 → 模型价格** 中配置：

```json
{
  "kling-v1-6": 0.056,
  "kling-v1-5": 0.056,
  "kling-v1": 0.028,
  "kling-v2-1": 0.056,
  "kling-v2-5-turbo": 0.042,
  "kling-v2-6": 0.07,
  "kling-video-o1": 0.084
}
```

> 注：以上价格为普通视频生成 Std 模式下的**每秒价格**（单位：元）

---

## 一、普通视频生成 (text2video / image2video / omni-video)

### 官方价格（每秒）

| 模型 | Std 模式 | Pro 模式 | Master 模式 |
|------|----------|----------|-------------|
| kling-v1 | 0.028元 | 0.098元 | - |
| kling-v1-5 | 0.056元 | 0.098元 | - |
| kling-v1-6 | 0.056元 | 0.098元 | - |
| kling-v2-1 | 0.056元 | 0.098元 | - |
| kling-v2-5-turbo | 0.042元 | 0.07元 | - |
| kling-v2-6 | 0.07元 | 0.07元 | - |
| kling-v2-1-master | - | - | 专属定价 |
| kling-v2-master | - | - | 专属定价 |
| kling-video-o1 | 0.084元 | 0.112元 | - |

### 计算策略

```go
// Pro 模式相对于 Std 的倍率
proScaleMap = {
    "kling-video-o1":   0.112 / 0.084,  // 1.333
    "kling-v2-6":       0.07 / 0.07,    // 1.0 (Pro和Std价格相同)
    "kling-v2-5-turbo": 0.07 / 0.042,   // 1.667
    "kling-v2-1":       0.098 / 0.056,  // 1.75
    "kling-v1-6":       0.098 / 0.056,  // 1.75
    "kling-v1-5":       0.098 / 0.056,  // 1.75
    "kling-v1":         0.098 / 0.028,  // 3.5
}
```

### 附加倍率

| 功能 | 适用模型 | 倍率 | 说明 |
|------|----------|------|------|
| 视频输入 | kling-video-o1 | ×1.5 | 使用 VideoList 输入视频时 |
| 开启音频 | kling-v2-6 | ×2.0 | sound="on" 时 |
| 音色控制 | kling-v2-6 | ×1.2 | 使用 VoiceList 时（叠加在音频倍率上） |

### 计算示例

**kling-v1-6 Pro 10秒视频**：
```
价格 = 0.056 × 10 × 1.75 = 0.98元
```

**kling-v2-6 Std 5秒 + 音频 + 音色控制**：
```
价格 = 0.07 × 5 × 1.0 × 2.0 × 1.2 = 0.84元
```

---

## 二、多图参考生视频 (multi-image2video)

### 官方价格

| 模型 | 模式 | 5秒 | 10秒 | 每秒价格 |
|------|------|-----|------|----------|
| kling-v1-6 | Std | 2元 | 4元 | 0.4元 |
| kling-v1-6 | Pro | 3.5元 | 7元 | 0.7元 |

### 计算策略

```go
// Std 模式基础倍率（相对于普通视频）
// 多图生视频每秒0.4元，普通视频每秒0.056元
// 倍率 = 0.4 / 0.056 ≈ 7.14
multiImage2VideoStdScaleMap = {
    "kling-v1-6": 2.0 / 0.28,  // 约 7.14
}

// Pro 模式相对于 Std 的倍率
// 3.5 / 2.0 = 1.75
multiImage2VideoProScale = 1.75
```

### 计算公式

```
GetPriceScale = duration × stdScale × (mode == "pro" ? proScale : 1.0)
```

### 验证

| 场景 | 计算 | 结果 | 官方价格 |
|------|------|------|----------|
| Std 5s | 0.056 × 5 × 7.14 | 2.0元 | 2元 ✅ |
| Std 10s | 0.056 × 10 × 7.14 | 4.0元 | 4元 ✅ |
| Pro 5s | 0.056 × 5 × 7.14 × 1.75 | 3.5元 | 3.5元 ✅ |
| Pro 10s | 0.056 × 10 × 7.14 × 1.75 | 7.0元 | 7元 ✅ |

---

## 三、视频延长 (video-extend)

### 官方价格（按次计费）

| 模型 | Std 模式 | Pro 模式 |
|------|----------|----------|
| kling-v1 | 1元/次 | 3.5元/次 |
| kling-v1-5 | 2元/次 | 3.5元/次 |
| kling-v1-6 | 2元/次 | 3.5元/次 |

> 每次延长约 4-5 秒

### 计算策略

```go
// Std 模式基础倍率（以 V1 std=1元为基准）
videoExtendStdScaleMap = {
    "kling-v1":   1.0,   // 1元
    "kling-v1-5": 2.0,   // 2元
    "kling-v1-6": 2.0,   // 2元
}

// Pro 模式相对于 Std 的倍率
videoExtendProScaleMap = {
    "kling-v1":   3.5 / 1.0,  // 3.5
    "kling-v1-5": 3.5 / 2.0,  // 1.75
    "kling-v1-6": 3.5 / 2.0,  // 1.75
}
```

### 计算公式

```
GetPriceScale = 1.0 × stdScale × (mode == "pro" ? proScale : 1.0)
```

> 注：duration 固定为 1.0（按次计费）

### 验证

假设 ModelPrice["kling-v1-6"] = 0.056：

| 场景 | 计算 | 结果 | 官方价格 |
|------|------|------|----------|
| V1.6 Std | 0.056 × 1 × (2.0/0.056) | 2.0元 | 2元 ✅ |
| V1.6 Pro | 0.056 × 1 × (2.0/0.056) × 1.75 | 3.5元 | 3.5元 ✅ |

**注意**：视频延长的 stdScale 实际上是 `目标价格 / ModelPrice`，确保最终价格正确。

---

## 四、对口型 (advanced-lip-sync)

### 官方价格

| 计费维度 | 价格 |
|----------|------|
| 每5秒 | 0.5元 |
| 最小计费单位 | 5秒 |
| 不足5秒 | 按5秒计算 |

### 计算策略

```go
const advancedLipSyncPricePerUnit = 0.5  // 每5秒0.5元
const advancedLipSyncUnitSeconds = 5.0   // 计费单位：5秒

// 计算公式
units = ceil(音频时长(秒) / 5)
GetPriceScale = units × 0.5
```

### 计算示例

| 音频时长 | 计费单位数 | 价格 |
|----------|------------|------|
| 3秒 | 1 | 0.5元 |
| 5秒 | 1 | 0.5元 |
| 7秒 | 2 | 1.0元 |
| 10秒 | 2 | 1.0元 |
| 12秒 | 3 | 1.5元 |

### 注意事项

- 对口型按**音频时长**计费，与视频时长无关
- 不区分 Std/Pro 模式
- unitPriceScale 固定为 1.0，价格直接通过 duration 计算

---

## 五、多模态视频编辑 (multi-elements)

### 官方价格

| 模式 | 5秒 | 10秒 | 每秒价格 |
|------|-----|------|----------|
| Std | 3元 | 6元 | 0.6元 |
| Pro | 5元 | 10元 | 1.0元 |

### 计算策略

```go
// Pro 模式相对于 Std 的倍率
// 5 / 3 ≈ 1.667
multiElementsProScale = 5.0 / 3.0
```

### 计算公式

```
GetPriceScale = duration × (mode == "pro" ? 1.667 : 1.0)
```

### 验证

假设 ModelPrice 配置使 Std 每秒 = 0.6元（需特殊配置或通过计算得出）：

| 场景 | 计算 | 结果 | 官方价格 |
|------|------|------|----------|
| Std 5s | 0.6 × 5 × 1.0 | 3元 | 3元 ✅ |
| Std 10s | 0.6 × 10 × 1.0 | 6元 | 6元 ✅ |
| Pro 5s | 0.6 × 5 × 1.667 | 5元 | 5元 ✅ |
| Pro 10s | 0.6 × 10 × 1.667 | 10元 | 10元 ✅ |

---

## 六、动作控制 (motion-control)

### 官方价格

| 模式 | 参考价格 |
|------|----------|
| Std | 基准价 |
| Pro | Std × 1.6 |

### 计算策略

```go
// Pro 模式相对于 Std 的倍率
motionControlProScale = 1.6  // 0.8 / 0.5
```

### 预扣费时长

- `character_orientation = "image"`: 预扣 10秒
- `character_orientation = "video"`: 预扣 30秒

---

## 价格对比总览

| 功能 | 计费方式 | 5秒参考价格 (Std) | 相对普通视频 |
|------|----------|-------------------|--------------|
| 普通视频生成 | 按时长 | ~0.28-0.35元 | 基准 (1×) |
| 多图参考生视频 | 按时长 | 2元 | ~7× |
| 对口型 | 按音频时长 | 0.5元 | ~1.5-2× |
| 视频延长 | 按次 | 2元/次 | ~7× |
| 多模态编辑 | 按时长 | 3元 | ~10× |
| 动作控制 | 按时长 | 视模型而定 | 视模型而定 |

---

## 代码实现位置

所有计费逻辑位于：`relay/channel/task/kling/adaptor.go`

主要函数：
- `calculateUnitPriceScale()`: 计算单价系数
- `GetPriceScale()`: 计算总价格倍率（预扣费）
- `GetUnitPriceScale()`: 获取单价系数（异步核销）

---

## 更新日志

| 日期 | 更新内容 |
|------|----------|
| 2025-01-22 | 新增多图参考生视频计费支持 |
| - | 初始版本：普通视频、视频延长、对口型、多模态编辑、动作控制 |
